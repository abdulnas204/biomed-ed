// xpath.js - version 0.7 - Spry Pre-Release 1.6.1
//
// Code from xmltoken.js.
//
// Copyright 2006 Google Inc.
// All Rights Reserved
//
// Defines regular expression patterns to extract XML tokens from string.
// See <http://www.w3.org/TR/REC-xml/#sec-common-syn>,
// <http://www.w3.org/TR/xml11/#sec-common-syn> and
// <http://www.w3.org/TR/REC-xml-names/#NT-NCName> for the specifications.
//
// Author: Junji Takagi <jtakagi@google.com>

// Detect whether RegExp supports Unicode characters or not.

var REGEXP_UNICODE=function(){var a=[' ','\u0120',-1,'!','\u0120',-1,'\u0120','\u0120',0,'\u0121','\u0120',-1,'\u0121','\u0120|\u0121',0,'\u0122','\u0120|\u0121',-1,'\u0120','[\u0120]',0,'\u0121','[\u0120]',-1,'\u0121','[\u0120\u0121]',0,'\u0122','[\u0120\u0121]',-1,'\u0121','[\u0120-\u0121]',0,'\u0122','[\u0120-\u0121]',-1];for(var i=0;i<a.length;i+=3){if(a[i].search(new RegExp(a[i+1]))!=a[i+2]){return false}}return true}();var XML_S='[ \t\r\n]+';var XML_EQ='('+XML_S+')?=('+XML_S+')?';var XML_CHAR_REF='&#[0-9]+;|&#x[0-9a-fA-F]+;';var XML10_VERSION_INFO=XML_S+'version'+XML_EQ+'("1\\.0"|'+"'1\\.0')";var XML10_BASE_CHAR=(REGEXP_UNICODE)?'\u0041-\u005a\u0061-\u007a\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u00ff'+'\u0100-\u0131\u0134-\u013e\u0141-\u0148\u014a-\u017e\u0180-\u01c3'+'\u01cd-\u01f0\u01f4-\u01f5\u01fa-\u0217\u0250-\u02a8\u02bb-\u02c1\u0386'+'\u0388-\u038a\u038c\u038e-\u03a1\u03a3-\u03ce\u03d0-\u03d6\u03da\u03dc'+'\u03de\u03e0\u03e2-\u03f3\u0401-\u040c\u040e-\u044f\u0451-\u045c'+'\u045e-\u0481\u0490-\u04c4\u04c7-\u04c8\u04cb-\u04cc\u04d0-\u04eb'+'\u04ee-\u04f5\u04f8-\u04f9\u0531-\u0556\u0559\u0561-\u0586\u05d0-\u05ea'+'\u05f0-\u05f2\u0621-\u063a\u0641-\u064a\u0671-\u06b7\u06ba-\u06be'+'\u06c0-\u06ce\u06d0-\u06d3\u06d5\u06e5-\u06e6\u0905-\u0939\u093d'+'\u0958-\u0961\u0985-\u098c\u098f-\u0990\u0993-\u09a8\u09aa-\u09b0\u09b2'+'\u09b6-\u09b9\u09dc-\u09dd\u09df-\u09e1\u09f0-\u09f1\u0a05-\u0a0a'+'\u0a0f-\u0a10\u0a13-\u0a28\u0a2a-\u0a30\u0a32-\u0a33\u0a35-\u0a36'+'\u0a38-\u0a39\u0a59-\u0a5c\u0a5e\u0a72-\u0a74\u0a85-\u0a8b\u0a8d'+'\u0a8f-\u0a91\u0a93-\u0aa8\u0aaa-\u0ab0\u0ab2-\u0ab3\u0ab5-\u0ab9'+'\u0abd\u0ae0\u0b05-\u0b0c\u0b0f-\u0b10\u0b13-\u0b28\u0b2a-\u0b30'+'\u0b32-\u0b33\u0b36-\u0b39\u0b3d\u0b5c-\u0b5d\u0b5f-\u0b61\u0b85-\u0b8a'+'\u0b8e-\u0b90\u0b92-\u0b95\u0b99-\u0b9a\u0b9c\u0b9e-\u0b9f\u0ba3-\u0ba4'+'\u0ba8-\u0baa\u0bae-\u0bb5\u0bb7-\u0bb9\u0c05-\u0c0c\u0c0e-\u0c10'+'\u0c12-\u0c28\u0c2a-\u0c33\u0c35-\u0c39\u0c60-\u0c61\u0c85-\u0c8c'+'\u0c8e-\u0c90\u0c92-\u0ca8\u0caa-\u0cb3\u0cb5-\u0cb9\u0cde\u0ce0-\u0ce1'+'\u0d05-\u0d0c\u0d0e-\u0d10\u0d12-\u0d28\u0d2a-\u0d39\u0d60-\u0d61'+'\u0e01-\u0e2e\u0e30\u0e32-\u0e33\u0e40-\u0e45\u0e81-\u0e82\u0e84'+'\u0e87-\u0e88\u0e8a\u0e8d\u0e94-\u0e97\u0e99-\u0e9f\u0ea1-\u0ea3\u0ea5'+'\u0ea7\u0eaa-\u0eab\u0ead-\u0eae\u0eb0\u0eb2-\u0eb3\u0ebd\u0ec0-\u0ec4'+'\u0f40-\u0f47\u0f49-\u0f69\u10a0-\u10c5\u10d0-\u10f6\u1100\u1102-\u1103'+'\u1105-\u1107\u1109\u110b-\u110c\u110e-\u1112\u113c\u113e\u1140\u114c'+'\u114e\u1150\u1154-\u1155\u1159\u115f-\u1161\u1163\u1165\u1167\u1169'+'\u116d-\u116e\u1172-\u1173\u1175\u119e\u11a8\u11ab\u11ae-\u11af'+'\u11b7-\u11b8\u11ba\u11bc-\u11c2\u11eb\u11f0\u11f9\u1e00-\u1e9b'+'\u1ea0-\u1ef9\u1f00-\u1f15\u1f18-\u1f1d\u1f20-\u1f45\u1f48-\u1f4d'+'\u1f50-\u1f57\u1f59\u1f5b\u1f5d\u1f5f-\u1f7d\u1f80-\u1fb4\u1fb6-\u1fbc'+'\u1fbe\u1fc2-\u1fc4\u1fc6-\u1fcc\u1fd0-\u1fd3\u1fd6-\u1fdb\u1fe0-\u1fec'+'\u1ff2-\u1ff4\u1ff6-\u1ffc\u2126\u212a-\u212b\u212e\u2180-\u2182'+'\u3041-\u3094\u30a1-\u30fa\u3105-\u312c\uac00-\ud7a3':'A-Za-z';var XML10_IDEOGRAPHIC=(REGEXP_UNICODE)?'\u4e00-\u9fa5\u3007\u3021-\u3029':'';var XML10_COMBINING_CHAR=(REGEXP_UNICODE)?'\u0300-\u0345\u0360-\u0361\u0483-\u0486\u0591-\u05a1\u05a3-\u05b9'+'\u05bb-\u05bd\u05bf\u05c1-\u05c2\u05c4\u064b-\u0652\u0670\u06d6-\u06dc'+'\u06dd-\u06df\u06e0-\u06e4\u06e7-\u06e8\u06ea-\u06ed\u0901-\u0903\u093c'+'\u093e-\u094c\u094d\u0951-\u0954\u0962-\u0963\u0981-\u0983\u09bc\u09be'+'\u09bf\u09c0-\u09c4\u09c7-\u09c8\u09cb-\u09cd\u09d7\u09e2-\u09e3\u0a02'+'\u0a3c\u0a3e\u0a3f\u0a40-\u0a42\u0a47-\u0a48\u0a4b-\u0a4d\u0a70-\u0a71'+'\u0a81-\u0a83\u0abc\u0abe-\u0ac5\u0ac7-\u0ac9\u0acb-\u0acd\u0b01-\u0b03'+'\u0b3c\u0b3e-\u0b43\u0b47-\u0b48\u0b4b-\u0b4d\u0b56-\u0b57\u0b82-\u0b83'+'\u0bbe-\u0bc2\u0bc6-\u0bc8\u0bca-\u0bcd\u0bd7\u0c01-\u0c03\u0c3e-\u0c44'+'\u0c46-\u0c48\u0c4a-\u0c4d\u0c55-\u0c56\u0c82-\u0c83\u0cbe-\u0cc4'+'\u0cc6-\u0cc8\u0cca-\u0ccd\u0cd5-\u0cd6\u0d02-\u0d03\u0d3e-\u0d43'+'\u0d46-\u0d48\u0d4a-\u0d4d\u0d57\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1'+'\u0eb4-\u0eb9\u0ebb-\u0ebc\u0ec8-\u0ecd\u0f18-\u0f19\u0f35\u0f37\u0f39'+'\u0f3e\u0f3f\u0f71-\u0f84\u0f86-\u0f8b\u0f90-\u0f95\u0f97\u0f99-\u0fad'+'\u0fb1-\u0fb7\u0fb9\u20d0-\u20dc\u20e1\u302a-\u302f\u3099\u309a':'';var XML10_DIGIT=(REGEXP_UNICODE)?'\u0030-\u0039\u0660-\u0669\u06f0-\u06f9\u0966-\u096f\u09e6-\u09ef'+'\u0a66-\u0a6f\u0ae6-\u0aef\u0b66-\u0b6f\u0be7-\u0bef\u0c66-\u0c6f'+'\u0ce6-\u0cef\u0d66-\u0d6f\u0e50-\u0e59\u0ed0-\u0ed9\u0f20-\u0f29':'0-9';var XML10_EXTENDER=(REGEXP_UNICODE)?'\u00b7\u02d0\u02d1\u0387\u0640\u0e46\u0ec6\u3005\u3031-\u3035'+'\u309d-\u309e\u30fc-\u30fe':'';var XML10_LETTER=XML10_BASE_CHAR+XML10_IDEOGRAPHIC;var XML10_NAME_CHAR=XML10_LETTER+XML10_DIGIT+'\\._:'+XML10_COMBINING_CHAR+XML10_EXTENDER+'-';var XML10_NAME='['+XML10_LETTER+'_:]['+XML10_NAME_CHAR+']*';var XML10_ENTITY_REF='&'+XML10_NAME+';';var XML10_REFERENCE=XML10_ENTITY_REF+'|'+XML_CHAR_REF;var XML10_ATT_VALUE='"(([^<&"]|'+XML10_REFERENCE+')*)"|'+"'(([^<&']|"+XML10_REFERENCE+")*)'";var XML10_ATTRIBUTE='('+XML10_NAME+')'+XML_EQ+'('+XML10_ATT_VALUE+')';var XML11_VERSION_INFO=XML_S+'version'+XML_EQ+'("1\\.1"|'+"'1\\.1')";var XML11_NAME_START_CHAR=(REGEXP_UNICODE)?':A-Z_a-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02ff\u0370-\u037d'+'\u037f-\u1fff\u200c-\u200d\u2070-\u218f\u2c00-\u2fef\u3001-\ud7ff'+'\uf900-\ufdcf\ufdf0-\ufffd':':A-Z_a-z';var XML11_NAME_CHAR=XML11_NAME_START_CHAR+((REGEXP_UNICODE)?'\\.0-9\u00b7\u0300-\u036f\u203f-\u2040-':'\\.0-9-');var XML11_NAME='['+XML11_NAME_START_CHAR+']['+XML11_NAME_CHAR+']*';var XML11_ENTITY_REF='&'+XML11_NAME+';';var XML11_REFERENCE=XML11_ENTITY_REF+'|'+XML_CHAR_REF;var XML11_ATT_VALUE='"(([^<&"]|'+XML11_REFERENCE+')*)"|'+"'(([^<&']|"+XML11_REFERENCE+")*)'";var XML11_ATTRIBUTE='('+XML11_NAME+')'+XML_EQ+'('+XML11_ATT_VALUE+')';var XML_NC_NAME_CHAR=XML10_LETTER+XML10_DIGIT+'\\._'+XML10_COMBINING_CHAR+XML10_EXTENDER+'-';var XML_NC_NAME='['+XML10_LETTER+'_]['+XML_NC_NAME_CHAR+']*';var DOM_ELEMENT_NODE=1;var DOM_ATTRIBUTE_NODE=2;var DOM_TEXT_NODE=3;var DOM_CDATA_SECTION_NODE=4;var DOM_ENTITY_REFERENCE_NODE=5;var DOM_ENTITY_NODE=6;var DOM_PROCESSING_INSTRUCTION_NODE=7;var DOM_COMMENT_NODE=8;var DOM_DOCUMENT_NODE=9;var DOM_DOCUMENT_TYPE_NODE=10;var DOM_DOCUMENT_FRAGMENT_NODE=11;var DOM_NOTATION_NODE=12;function xpathLog(a){};function xsltLog(a){};function xsltLogXml(a){};function assert(b){if(!b){throw"Assertion failed";}}function stringSplit(s,c){var a=s.indexOf(c);if(a==-1){return[s]}var b=[];b.push(s.substr(0,a));while(a!=-1){var d=s.indexOf(c,a+1);if(d!=-1){b.push(s.substr(a+1,d-a-1))}else{b.push(s.substr(a+1))}a=d}return b}function mapExec(a,b){for(var i=0;i<a.length;++i){b.call(this,a[i],i)}}function mapExpr(a,b){var c=[];for(var i=0;i<a.length;++i){c.push(b(a[i]))}return c};function reverseInplace(a){for(var i=0;i<a.length/2;++i){var h=a[i];var b=a.length-i-1;a[i]=a[b];a[b]=h}}function removeFromArray(a,b,c){var d=0;for(var i=0;i<a.length;++i){if(a[i]===b||(c&&a[i]==b)){a.splice(i--,1);d++}}return d}function copyArray(a,b){for(var i=0;i<b.length;++i){a.push(b[i])}}function xmlValue(a){if(!a){return''}var b='';if(a.nodeType==DOM_TEXT_NODE||a.nodeType==DOM_CDATA_SECTION_NODE||a.nodeType==DOM_ATTRIBUTE_NODE){b+=a.nodeValue}else if(a.nodeType==DOM_ELEMENT_NODE||a.nodeType==DOM_DOCUMENT_NODE||a.nodeType==DOM_DOCUMENT_FRAGMENT_NODE){for(var i=0;i<a.childNodes.length;++i){b+=arguments.callee(a.childNodes[i])}}return b}function xpathParse(a){xpathLog('parse '+a);xpathParseInit();var b=xpathCacheLookup(a);if(b){xpathLog(' ... cached');return b}if(a.match(/^(\$|@)?\w+$/i)){var c=makeSimpleExpr(a);xpathParseCache[a]=c;xpathLog(' ... simple');return c}if(a.match(/^\w+(\/\w+)*$/i)){var c=makeSimpleExpr2(a);xpathParseCache[a]=c;xpathLog(' ... simple 2');return c}var d=a;var e=[];var f=null;var g=null;var h=false;var j=0;var k=0;var l=0;while(!h){j++;a=a.replace(/^\s*/,'');g=f;f=null;var m=null;var n='';for(var i=0;i<xpathTokenRules.length;++i){var o=xpathTokenRules[i].re.exec(a);k++;if(o&&o.length>0&&o[0].length>n.length){m=xpathTokenRules[i];n=o[0];break}}if(m&&(m==TOK_DIV||m==TOK_MOD||m==TOK_AND||m==TOK_OR)&&(!g||g.tag==TOK_AT||g.tag==TOK_DSLASH||g.tag==TOK_SLASH||g.tag==TOK_AXIS||g.tag==TOK_DOLLAR)){m=TOK_QNAME}if(m){a=a.substr(n.length);xpathLog('token: '+n+' -- '+m.label);f={tag:m,match:n,prec:m.prec?m.prec:0,expr:makeTokenExpr(n)}}else{xpathLog('DONE');h=true}while(xpathReduce(e,f)){l++;xpathLog('stack: '+stackToString(e))}}xpathLog('stack: '+stackToString(e));if(e.length!=1){throw'XPath parse error '+d+':\n'+stackToString(e);}var o=e[0].expr;xpathParseCache[d]=o;xpathLog('XPath parse: '+j+' / '+k+' / '+l);return o}var xpathParseCache={};function xpathCacheLookup(a){return xpathParseCache[a]}function xpathReduce(a,b){var c=null;if(a.length>0){var d=a[a.length-1];var e=xpathRules[d.tag.key];if(e){for(var i=0;i<e.length;++i){var f=e[i];var g=xpathMatchStack(a,f[1]);if(g.length){c={tag:f[0],rule:f,match:g};c.prec=xpathGrammarPrecedence(c);break}}}}var h;if(c&&(!b||c.prec>b.prec||(b.tag.left&&c.prec>=b.prec))){for(var i=0;i<c.match.matchlength;++i){a.pop()}xpathLog('reduce '+c.tag.label+' '+c.prec+' ahead '+(b?b.tag.label+' '+b.prec+(b.tag.left?' left':''):' none '));var j=mapExpr(c.match,function(m){return m.expr});c.expr=c.rule[3].apply(null,j);a.push(c);h=true}else{if(b){xpathLog('shift '+b.tag.label+' '+b.prec+(b.tag.left?' left':'')+' over '+(c?c.tag.label+' '+c.prec:' none'));a.push(b)}h=false}return h}function xpathMatchStack(a,b){var S=a.length;var P=b.length;var p,s;var c=[];c.matchlength=0;var d=0;for(p=P-1,s=S-1;p>=0&&s>=0;--p,s-=d){d=0;var e=[];if(b[p]==Q_MM){p-=1;c.push(e);while(s-d>=0&&a[s-d].tag==b[p]){e.push(a[s-d]);d+=1;c.matchlength+=1}}else if(b[p]==Q_01){p-=1;c.push(e);while(s-d>=0&&d<2&&a[s-d].tag==b[p]){e.push(a[s-d]);d+=1;c.matchlength+=1}}else if(b[p]==Q_1M){p-=1;c.push(e);if(a[s].tag==b[p]){while(s-d>=0&&a[s-d].tag==b[p]){e.push(a[s-d]);d+=1;c.matchlength+=1}}else{return[]}}else if(a[s].tag==b[p]){c.push(a[s]);d+=1;c.matchlength+=1}else{return[]}reverseInplace(e);e.expr=mapExpr(e,function(m){return m.expr})}reverseInplace(c);if(p==-1){return c}else{return[]}}function xpathTokenPrecedence(a){return a.prec||2}function xpathGrammarPrecedence(a){var b=0;if(a.rule){if(a.rule.length>=3&&a.rule[2]>=0){b=a.rule[2]}else{for(var i=0;i<a.rule[1].length;++i){var p=xpathTokenPrecedence(a.rule[1][i]);b=Math.max(b,p)}}}else if(a.tag){b=xpathTokenPrecedence(a.tag)}else if(a.length){for(var j=0;j<a.length;++j){var p=xpathGrammarPrecedence(a[j]);b=Math.max(b,p)}}return b}function stackToString(a){var b='';for(var i=0;i<a.length;++i){if(b){b+='\n'}b+=a[i].tag.label}return b}function ExprContext(a,b,c,d){this.node=a;this.position=b||0;this.nodelist=c||[a];this.variables={};this.parent=d||null;if(d){this.root=d.root}else if(this.node.nodeType==DOM_DOCUMENT_NODE){this.root=a}else{this.root=a.ownerDocument}}ExprContext.prototype.clone=function(a,b,c){return new ExprContext(a||this.node,typeof b!='undefined'?b:this.position,c||this.nodelist,this)};ExprContext.prototype.setVariable=function(a,b){this.variables[a]=b};ExprContext.prototype.getVariable=function(a){if(typeof this.variables[a]!='undefined'){return this.variables[a]}else if(this.parent){return this.parent.getVariable(a)}else{return null}};ExprContext.prototype.setNode=function(a){this.node=this.nodelist[a];this.position=a};ExprContext.prototype.contextSize=function(){return this.nodelist.length};function StringValue(a){this.value=a;this.type='string'}StringValue.prototype.stringValue=function(){return this.value};StringValue.prototype.booleanValue=function(){return this.value.length>0};StringValue.prototype.numberValue=function(){return this.value-0};StringValue.prototype.nodeSetValue=function(){throw this;};function BooleanValue(a){this.value=a;this.type='boolean'}BooleanValue.prototype.stringValue=function(){return''+this.value};BooleanValue.prototype.booleanValue=function(){return this.value};BooleanValue.prototype.numberValue=function(){return this.value?1:0};BooleanValue.prototype.nodeSetValue=function(){throw this;};function NumberValue(a){this.value=a;this.type='number'}NumberValue.prototype.stringValue=function(){return''+this.value};NumberValue.prototype.booleanValue=function(){return!!this.value};NumberValue.prototype.numberValue=function(){return this.value-0};NumberValue.prototype.nodeSetValue=function(){throw this;};function NodeSetValue(a){this.value=a;this.type='node-set'}NodeSetValue.prototype.stringValue=function(){if(this.value.length==0){return''}else{return xmlValue(this.value[0])}};NodeSetValue.prototype.booleanValue=function(){return this.value.length>0};NodeSetValue.prototype.numberValue=function(){return this.stringValue()-0};NodeSetValue.prototype.nodeSetValue=function(){return this.value};function TokenExpr(m){this.value=m}TokenExpr.prototype.evaluate=function(){return new StringValue(this.value)};function LocationExpr(){this.absolute=false;this.steps=[]}LocationExpr.prototype.appendStep=function(s){this.steps.push(s)};LocationExpr.prototype.prependStep=function(s){var a=this.steps;this.steps=[s];for(var i=0;i<a.length;++i){this.steps.push(a[i])}};LocationExpr.prototype.evaluate=function(a){var b;if(this.absolute){b=a.root}else{b=a.node}var c=[];xPathStep(c,this.steps,0,b,a);return new NodeSetValue(c)};function xPathStep(a,b,c,d,e){var s=b[c];var f=e.clone(d);var g=s.evaluate(f).nodeSetValue();for(var i=0;i<g.length;++i){if(c==b.length-1){a.push(g[i])}else{xPathStep(a,b,c+1,g[i],e)}}}function StepExpr(a,b,c){this.axis=a;this.nodetest=b;this.predicate=c||[]}StepExpr.prototype.appendPredicate=function(p){this.predicate.push(p)};StepExpr.prototype.evaluate=function(a){var b=a.node;var c=[];if(this.axis==xpathAxis.ANCESTOR_OR_SELF){c.push(b);for(var n=b.parentNode;n;n=n.parentNode){c.push(n)}}else if(this.axis==xpathAxis.ANCESTOR){for(var n=b.parentNode;n;n=n.parentNode){c.push(n)}}else if(this.axis==xpathAxis.ATTRIBUTE){copyArray(c,b.attributes)}else if(this.axis==xpathAxis.CHILD){copyArray(c,b.childNodes)}else if(this.axis==xpathAxis.DESCENDANT_OR_SELF){c.push(b);xpathCollectDescendants(c,b)}else if(this.axis==xpathAxis.DESCENDANT){xpathCollectDescendants(c,b)}else if(this.axis==xpathAxis.FOLLOWING){for(var n=b;n;n=n.parentNode){for(var d=n.nextSibling;d;d=d.nextSibling){c.push(d);xpathCollectDescendants(c,d)}}}else if(this.axis==xpathAxis.FOLLOWING_SIBLING){for(var n=b.nextSibling;n;n=n.nextSibling){c.push(n)}}else if(this.axis==xpathAxis.NAMESPACE){alert('not implemented: axis namespace')}else if(this.axis==xpathAxis.PARENT){if(b.parentNode){c.push(b.parentNode)}}else if(this.axis==xpathAxis.PRECEDING){for(var n=b;n;n=n.parentNode){for(var d=n.previousSibling;d;d=d.previousSibling){c.push(d);xpathCollectDescendantsReverse(c,d)}}}else if(this.axis==xpathAxis.PRECEDING_SIBLING){for(var n=b.previousSibling;n;n=n.previousSibling){c.push(n)}}else if(this.axis==xpathAxis.SELF){c.push(b)}else{throw'ERROR -- NO SUCH AXIS: '+this.axis;}var e=c;c=[];for(var i=0;i<e.length;++i){var n=e[i];if(this.nodetest.evaluate(a.clone(n,i,e)).booleanValue()){c.push(n)}}for(var i=0;i<this.predicate.length;++i){var e=c;c=[];for(var f=0;f<e.length;++f){var n=e[f];if(this.predicate[i].evaluate(a.clone(n,f,e)).booleanValue()){c.push(n)}}}return new NodeSetValue(c)};function NodeTestAny(){this.value=new BooleanValue(true)}NodeTestAny.prototype.evaluate=function(a){return this.value};function NodeTestElementOrAttribute(){}NodeTestElementOrAttribute.prototype.evaluate=function(a){return new BooleanValue(a.node.nodeType==DOM_ELEMENT_NODE||a.node.nodeType==DOM_ATTRIBUTE_NODE)};function NodeTestText(){}NodeTestText.prototype.evaluate=function(a){return new BooleanValue(a.node.nodeType==DOM_TEXT_NODE)};function NodeTestComment(){}NodeTestComment.prototype.evaluate=function(a){return new BooleanValue(a.node.nodeType==DOM_COMMENT_NODE)};function NodeTestPI(a){this.target=a}NodeTestPI.prototype.evaluate=function(a){return new BooleanValue(a.node.nodeType==DOM_PROCESSING_INSTRUCTION_NODE&&(!this.target||a.node.nodeName==this.target))};function NodeTestNC(a){this.regex=new RegExp("^"+a+":");this.nsprefix=a}NodeTestNC.prototype.evaluate=function(a){var n=a.node;return new BooleanValue(this.regex.match(n.nodeName))};function NodeTestName(a){this.name=a}NodeTestName.prototype.evaluate=function(a){var n=a.node;return new BooleanValue(n.nodeName==this.name)};function PredicateExpr(a){this.expr=a}PredicateExpr.prototype.evaluate=function(a){var v=this.expr.evaluate(a);if(v.type=='number'){return new BooleanValue(a.position==v.numberValue()-1)}else{return new BooleanValue(v.booleanValue())}};function FunctionCallExpr(a){this.name=a;this.args=[]}FunctionCallExpr.prototype.appendArg=function(a){this.args.push(a)};FunctionCallExpr.prototype.evaluate=function(a){var b=''+this.name.value;var f=this.xpathfunctions[b];if(f){return f.call(this,a)}else{xpathLog('XPath NO SUCH FUNCTION '+b);return new BooleanValue(false)}};FunctionCallExpr.prototype.xpathfunctions={'last':function(a){assert(this.args.length==0);return new NumberValue(a.contextSize())},'position':function(a){assert(this.args.length==0);return new NumberValue(a.position+1)},'count':function(a){assert(this.args.length==1);var v=this.args[0].evaluate(a);return new NumberValue(v.nodeSetValue().length)},'id':function(a){assert(this.args.length==1);var e=this.args[0].evaluate(a);var b=[];var c;if(e.type=='node-set'){c=[];var f=e.nodeSetValue();for(var i=0;i<f.length;++i){var v=xmlValue(f[i]).split(/\s+/);for(var g=0;g<v.length;++g){c.push(v[g])}}}else{c=e.stringValue().split(/\s+/)}var d=a.node.ownerDocument;for(var i=0;i<c.length;++i){var n=d.getElementById(c[i]);if(n){b.push(n)}}return new NodeSetValue(b)},'local-name':function(a){alert('not implmented yet: XPath function local-name()')},'namespace-uri':function(a){alert('not implmented yet: XPath function namespace-uri()')},'name':function(a){assert(this.args.length==1||this.args.length==0);var n;if(this.args.length==0){n=[a.node]}else{n=this.args[0].evaluate(a).nodeSetValue()}if(n.length==0){return new StringValue('')}else{return new StringValue(n[0].nodeName)}},'string':function(a){assert(this.args.length==1||this.args.length==0);if(this.args.length==0){return new StringValue(new NodeSetValue([a.node]).stringValue())}else{return new StringValue(this.args[0].evaluate(a).stringValue())}},'concat':function(a){var b='';for(var i=0;i<this.args.length;++i){b+=this.args[i].evaluate(a).stringValue()}return new StringValue(b)},'starts-with':function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).stringValue();var c=this.args[1].evaluate(a).stringValue();return new BooleanValue(b.indexOf(c)==0)},'contains':function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).stringValue();var c=this.args[1].evaluate(a).stringValue();return new BooleanValue(b.indexOf(c)!=-1)},'substring-before':function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).stringValue();var c=this.args[1].evaluate(a).stringValue();var i=b.indexOf(c);var d;if(i==-1){d=''}else{d=b.substr(0,i)}return new StringValue(d)},'substring-after':function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).stringValue();var c=this.args[1].evaluate(a).stringValue();var i=b.indexOf(c);var d;if(i==-1){d=''}else{d=b.substr(i+c.length)}return new StringValue(d)},'substring':function(a){assert(this.args.length==2||this.args.length==3);var b=this.args[0].evaluate(a).stringValue();var c=this.args[1].evaluate(a).numberValue();var d;if(this.args.length==2){var e=Math.max(0,Math.round(c)-1);d=b.substr(e)}else{var f=this.args[2].evaluate(a).numberValue();var g=Math.round(c)-1;var e=Math.max(0,g);var h=Math.round(f)-Math.max(0,-g);d=b.substr(e,h)}return new StringValue(d)},'string-length':function(a){var s;if(this.args.length>0){s=this.args[0].evaluate(a).stringValue()}else{s=new NodeSetValue([a.node]).stringValue()}return new NumberValue(s.length)},'normalize-space':function(a){var s;if(this.args.length>0){s=this.args[0].evaluate(a).stringValue()}else{s=new NodeSetValue([a.node]).stringValue()}s=s.replace(/^\s*/,'').replace(/\s*$/,'').replace(/\s+/g,' ');return new StringValue(s)},'translate':function(a){assert(this.args.length==3);var b=this.args[0].evaluate(a).stringValue();var c=this.args[1].evaluate(a).stringValue();var d=this.args[2].evaluate(a).stringValue();for(var i=0;i<c.length;++i){b=b.replace(new RegExp(c.charAt(i),'g'),d.charAt(i))}return new StringValue(b)},'boolean':function(a){assert(this.args.length==1);return new BooleanValue(this.args[0].evaluate(a).booleanValue())},'not':function(a){assert(this.args.length==1);var b=!this.args[0].evaluate(a).booleanValue();return new BooleanValue(b)},'true':function(a){assert(this.args.length==0);return new BooleanValue(true)},'false':function(a){assert(this.args.length==0);return new BooleanValue(false)},'lang':function(a){assert(this.args.length==1);var b=this.args[0].evaluate(a).stringValue();var c;var n=a.node;while(n&&n!=n.parentNode){c=n.getAttribute('xml:lang');if(c){break}n=n.parentNode}if(!c){return new BooleanValue(false)}else{var d=new RegExp('^'+b+'$','i');return new BooleanValue(c.match(d)||c.replace(/_.*$/,'').match(d))}},'number':function(a){assert(this.args.length==1||this.args.length==0);if(this.args.length==1){return new NumberValue(this.args[0].evaluate(a).numberValue())}else{return new NumberValue(new NodeSetValue([a.node]).numberValue())}},'sum':function(a){assert(this.args.length==1);var n=this.args[0].evaluate(a).nodeSetValue();var b=0;for(var i=0;i<n.length;++i){b+=xmlValue(n[i])-0}return new NumberValue(b)},'floor':function(a){assert(this.args.length==1);var b=this.args[0].evaluate(a).numberValue();return new NumberValue(Math.floor(b))},'ceiling':function(a){assert(this.args.length==1);var b=this.args[0].evaluate(a).numberValue();return new NumberValue(Math.ceil(b))},'round':function(a){assert(this.args.length==1);var b=this.args[0].evaluate(a).numberValue();return new NumberValue(Math.round(b))},'ext-join':function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).nodeSetValue();var c=this.args[1].evaluate(a).stringValue();var d='';for(var i=0;i<b.length;++i){if(d){d+=c}d+=xmlValue(b[i])}return new StringValue(d)},'ext-if':function(a){assert(this.args.length==3);if(this.args[0].evaluate(a).booleanValue()){return this.args[1].evaluate(a)}else{return this.args[2].evaluate(a)}},'ext-cardinal':function(a){assert(this.args.length>=1);var c=this.args[0].evaluate(a).numberValue();var b=[];for(var i=0;i<c;++i){b.push(a.node)}return new NodeSetValue(b)}};function UnionExpr(a,b){this.expr1=a;this.expr2=b}UnionExpr.prototype.evaluate=function(a){var b=this.expr1.evaluate(a).nodeSetValue();var c=this.expr2.evaluate(a).nodeSetValue();var d=b.length;for(var e=0;e<c.length;++e){var n=c[e];var f=false;for(var g=0;g<d;++g){if(b[g]==n){f=true;g=d}}if(!f){b.push(n)}}return new NodeSetValue(b)};function PathExpr(a,b){this.filter=a;this.rel=b}PathExpr.prototype.evaluate=function(a){var b=this.filter.evaluate(a).nodeSetValue();var c=[];for(var i=0;i<b.length;++i){var d=this.rel.evaluate(a.clone(b[i],i,b)).nodeSetValue();for(var e=0;e<d.length;++e){c.push(d[e])}}return new NodeSetValue(c)};function FilterExpr(a,b){this.expr=a;this.predicate=b}FilterExpr.prototype.evaluate=function(a){var b=this.expr.evaluate(a).nodeSetValue();for(var i=0;i<this.predicate.length;++i){var c=b;b=[];for(var j=0;j<c.length;++j){var n=c[j];if(this.predicate[i].evaluate(a.clone(n,j,c)).booleanValue()){b.push(n)}}}return new NodeSetValue(b)};function UnaryMinusExpr(a){this.expr=a}UnaryMinusExpr.prototype.evaluate=function(a){return new NumberValue(-this.expr.evaluate(a).numberValue())};function BinaryExpr(a,b,c){this.expr1=a;this.expr2=c;this.op=b}BinaryExpr.prototype.evaluate=function(c){var d;switch(this.op.value){case'or':d=new BooleanValue(this.expr1.evaluate(c).booleanValue()||this.expr2.evaluate(c).booleanValue());break;case'and':d=new BooleanValue(this.expr1.evaluate(c).booleanValue()&&this.expr2.evaluate(c).booleanValue());break;case'+':d=new NumberValue(this.expr1.evaluate(c).numberValue()+this.expr2.evaluate(c).numberValue());break;case'-':d=new NumberValue(this.expr1.evaluate(c).numberValue()-this.expr2.evaluate(c).numberValue());break;case'*':d=new NumberValue(this.expr1.evaluate(c).numberValue()*this.expr2.evaluate(c).numberValue());break;case'mod':d=new NumberValue(this.expr1.evaluate(c).numberValue()%this.expr2.evaluate(c).numberValue());break;case'div':d=new NumberValue(this.expr1.evaluate(c).numberValue()/this.expr2.evaluate(c).numberValue());break;case'=':d=this.compare(c,function(a,b){return a==b});break;case'!=':d=this.compare(c,function(a,b){return a!=b});break;case'<':d=this.compare(c,function(a,b){return a<b});break;case'<=':d=this.compare(c,function(a,b){return a<=b});break;case'>':d=this.compare(c,function(a,b){return a>b});break;case'>=':d=this.compare(c,function(a,b){return a>=b});break;default:alert('BinaryExpr.evaluate: '+this.op.value)}return d};BinaryExpr.prototype.compare=function(a,b){var c=this.expr1.evaluate(a);var d=this.expr2.evaluate(a);var e;if(c.type=='node-set'&&d.type=='node-set'){var f=c.nodeSetValue();var g=d.nodeSetValue();e=false;for(var h=0;h<f.length;++h){for(var j=0;j<g.length;++j){if(b(xmlValue(f[h]),xmlValue(g[j]))){e=true;j=g.length;h=f.length}}}}else if(c.type=='node-set'||d.type=='node-set'){if(c.type=='number'){var s=c.numberValue();var n=d.nodeSetValue();e=false;for(var i=0;i<n.length;++i){var k=xmlValue(n[i])-0;if(b(s,k)){e=true;break}}}else if(d.type=='number'){var n=c.nodeSetValue();var s=d.numberValue();e=false;for(var i=0;i<n.length;++i){var k=xmlValue(n[i])-0;if(b(k,s)){e=true;break}}}else if(c.type=='string'){var s=c.stringValue();var n=d.nodeSetValue();e=false;for(var i=0;i<n.length;++i){var k=xmlValue(n[i]);if(b(s,k)){e=true;break}}}else if(d.type=='string'){var n=c.nodeSetValue();var s=d.stringValue();e=false;for(var i=0;i<n.length;++i){var k=xmlValue(n[i]);if(b(k,s)){e=true;break}}}else{e=b(c.booleanValue(),d.booleanValue())}}else if(c.type=='boolean'||d.type=='boolean'){e=b(c.booleanValue(),d.booleanValue())}else if(c.type=='number'||d.type=='number'){e=b(c.numberValue(),d.numberValue())}else{e=b(c.stringValue(),d.stringValue())}return new BooleanValue(e)};function LiteralExpr(a){this.value=a}LiteralExpr.prototype.evaluate=function(a){return new StringValue(this.value)};function NumberExpr(a){this.value=a}NumberExpr.prototype.evaluate=function(a){return new NumberValue(this.value)};function VariableExpr(a){this.name=a}VariableExpr.prototype.evaluate=function(a){return a.getVariable(this.name)};function makeTokenExpr(m){return new TokenExpr(m)}function passExpr(e){return e}function makeLocationExpr1(a,b){b.absolute=true;return b}function makeLocationExpr2(a,b){b.absolute=true;b.prependStep(makeAbbrevStep(a.value));return b}function makeLocationExpr3(a){var b=new LocationExpr();b.appendStep(makeAbbrevStep('.'));b.absolute=true;return b}function makeLocationExpr4(a){var b=new LocationExpr();b.absolute=true;b.appendStep(makeAbbrevStep(a.value));return b}function makeLocationExpr5(a){var b=new LocationExpr();b.appendStep(a);return b}function makeLocationExpr6(a,b,c){a.appendStep(c);return a}function makeLocationExpr7(a,b,c){a.appendStep(makeAbbrevStep(b.value));return a}function makeStepExpr1(a){return makeAbbrevStep(a.value)}function makeStepExpr2(a){return makeAbbrevStep(a.value)}function makeStepExpr3(a,b,c){return new StepExpr(a.value,c)}function makeStepExpr4(a,b){return new StepExpr('attribute',b)}function makeStepExpr5(a){return new StepExpr('child',a)}function makeStepExpr6(a,b){a.appendPredicate(b);return a}function makeAbbrevStep(a){switch(a){case'//':return new StepExpr('descendant-or-self',new NodeTestAny);case'.':return new StepExpr('self',new NodeTestAny);case'..':return new StepExpr('parent',new NodeTestAny)}}function makeNodeTestExpr1(a){return new NodeTestElementOrAttribute}function makeNodeTestExpr2(a,b,c){return new NodeTestNC(a.value)}function makeNodeTestExpr3(a){return new NodeTestName(a.value)}function makeNodeTestExpr4(a,b){var c=a.value.replace(/\s*\($/,'');switch(c){case'node':return new NodeTestAny;case'text':return new NodeTestText;case'comment':return new NodeTestComment;case'processing-instruction':return new NodeTestPI('')}}function makeNodeTestExpr5(a,b,c){var d=a.replace(/\s*\($/,'');if(d!='processing-instruction'){throw d;}return new NodeTestPI(b.value)}function makePredicateExpr(a,b,c){return new PredicateExpr(b)}function makePrimaryExpr(a,b,c){return b}function makeFunctionCallExpr1(a,b,c){return new FunctionCallExpr(a)}function makeFunctionCallExpr2(a,b,c,d,e){var f=new FunctionCallExpr(a);f.appendArg(c);for(var i=0;i<d.length;++i){f.appendArg(d[i])}return f}function makeArgumentExpr(a,b){return b}function makeUnionExpr(a,b,c){return new UnionExpr(a,c)}function makePathExpr1(a,b,c){return new PathExpr(a,c)}function makePathExpr2(a,b,c){c.prependStep(makeAbbrevStep(b.value));return new PathExpr(a,c)}function makeFilterExpr(a,b){if(b.length>0){return new FilterExpr(a,b)}else{return a}}function makeUnaryMinusExpr(a,b){return new UnaryMinusExpr(b)}function makeBinaryExpr(a,b,c){return new BinaryExpr(a,b,c)}function makeLiteralExpr(a){var b=a.value.substring(1,a.value.length-1);return new LiteralExpr(b)}function makeNumberExpr(a){return new NumberExpr(a.value)}function makeVariableReference(a,b){return new VariableExpr(b.value)}function makeSimpleExpr(d){if(d.charAt(0)=='$'){return new VariableExpr(d.substr(1))}else if(d.charAt(0)=='@'){var a=new NodeTestName(d.substr(1));var b=new StepExpr('attribute',a);var c=new LocationExpr();c.appendStep(b);return c}else if(d.match(/^[0-9]+$/)){return new NumberExpr(d)}else{var a=new NodeTestName(d);var b=new StepExpr('child',a);var c=new LocationExpr();c.appendStep(b);return c}}function makeSimpleExpr2(d){var e=stringSplit(d,'/');var c=new LocationExpr();for(var i=0;i<e.length;++i){var a=new NodeTestName(e[i]);var b=new StepExpr('child',a);c.appendStep(b)}return c}var xpathAxis={ANCESTOR_OR_SELF:'ancestor-or-self',ANCESTOR:'ancestor',ATTRIBUTE:'attribute',CHILD:'child',DESCENDANT_OR_SELF:'descendant-or-self',DESCENDANT:'descendant',FOLLOWING_SIBLING:'following-sibling',FOLLOWING:'following',NAMESPACE:'namespace',PARENT:'parent',PRECEDING_SIBLING:'preceding-sibling',PRECEDING:'preceding',SELF:'self'};var xpathAxesRe=[xpathAxis.ANCESTOR_OR_SELF,xpathAxis.ANCESTOR,xpathAxis.ATTRIBUTE,xpathAxis.CHILD,xpathAxis.DESCENDANT_OR_SELF,xpathAxis.DESCENDANT,xpathAxis.FOLLOWING_SIBLING,xpathAxis.FOLLOWING,xpathAxis.NAMESPACE,xpathAxis.PARENT,xpathAxis.PRECEDING_SIBLING,xpathAxis.PRECEDING,xpathAxis.SELF].join('|');var TOK_PIPE={label:"|",prec:17,re:new RegExp("^\\|")};var TOK_DSLASH={label:"//",prec:19,re:new RegExp("^//")};var TOK_SLASH={label:"/",prec:30,re:new RegExp("^/")};var TOK_AXIS={label:"::",prec:20,re:new RegExp("^::")};var TOK_COLON={label:":",prec:1000,re:new RegExp("^:")};var TOK_AXISNAME={label:"[axis]",re:new RegExp('^('+xpathAxesRe+')')};var TOK_PARENO={label:"(",prec:34,re:new RegExp("^\\(")};var TOK_PARENC={label:")",re:new RegExp("^\\)")};var TOK_DDOT={label:"..",prec:34,re:new RegExp("^\\.\\.")};var TOK_DOT={label:".",prec:34,re:new RegExp("^\\.")};var TOK_AT={label:"@",prec:34,re:new RegExp("^@")};var TOK_COMMA={label:",",re:new RegExp("^,")};var TOK_OR={label:"or",prec:10,re:new RegExp("^or\\b")};var TOK_AND={label:"and",prec:11,re:new RegExp("^and\\b")};var TOK_EQ={label:"=",prec:12,re:new RegExp("^=")};var TOK_NEQ={label:"!=",prec:12,re:new RegExp("^!=")};var TOK_GE={label:">=",prec:13,re:new RegExp("^>=")};var TOK_GT={label:">",prec:13,re:new RegExp("^>")};var TOK_LE={label:"<=",prec:13,re:new RegExp("^<=")};var TOK_LT={label:"<",prec:13,re:new RegExp("^<")};var TOK_PLUS={label:"+",prec:14,re:new RegExp("^\\+"),left:true};var TOK_MINUS={label:"-",prec:14,re:new RegExp("^\\-"),left:true};var TOK_DIV={label:"div",prec:15,re:new RegExp("^div\\b"),left:true};var TOK_MOD={label:"mod",prec:15,re:new RegExp("^mod\\b"),left:true};var TOK_BRACKO={label:"[",prec:32,re:new RegExp("^\\[")};var TOK_BRACKC={label:"]",re:new RegExp("^\\]")};var TOK_DOLLAR={label:"$",re:new RegExp("^\\$")};var TOK_NCNAME={label:"[ncname]",re:new RegExp('^'+XML_NC_NAME)};var TOK_ASTERISK={label:"*",prec:15,re:new RegExp("^\\*"),left:true};var TOK_LITERALQ={label:"[litq]",prec:20,re:new RegExp("^'[^\\']*'")};var TOK_LITERALQQ={label:"[litqq]",prec:20,re:new RegExp('^"[^\\"]*"')};var TOK_NUMBER={label:"[number]",prec:35,re:new RegExp('^\\d+(\\.\\d*)?')};var TOK_QNAME={label:"[qname]",re:new RegExp('^('+XML_NC_NAME+':)?'+XML_NC_NAME)};var TOK_NODEO={label:"[nodetest-start]",re:new RegExp('^(processing-instruction|comment|text|node)\\(')};var xpathTokenRules=[TOK_DSLASH,TOK_SLASH,TOK_DDOT,TOK_DOT,TOK_AXIS,TOK_COLON,TOK_AXISNAME,TOK_NODEO,TOK_PARENO,TOK_PARENC,TOK_BRACKO,TOK_BRACKC,TOK_AT,TOK_COMMA,TOK_OR,TOK_AND,TOK_NEQ,TOK_EQ,TOK_GE,TOK_GT,TOK_LE,TOK_LT,TOK_PLUS,TOK_MINUS,TOK_ASTERISK,TOK_PIPE,TOK_MOD,TOK_DIV,TOK_LITERALQ,TOK_LITERALQQ,TOK_NUMBER,TOK_QNAME,TOK_NCNAME,TOK_DOLLAR];var XPathLocationPath={label:"LocationPath"};var XPathRelativeLocationPath={label:"RelativeLocationPath"};var XPathAbsoluteLocationPath={label:"AbsoluteLocationPath"};var XPathStep={label:"Step"};var XPathNodeTest={label:"NodeTest"};var XPathPredicate={label:"Predicate"};var XPathLiteral={label:"Literal"};var XPathExpr={label:"Expr"};var XPathPrimaryExpr={label:"PrimaryExpr"};var XPathVariableReference={label:"Variablereference"};var XPathNumber={label:"Number"};var XPathFunctionCall={label:"FunctionCall"};var XPathArgumentRemainder={label:"ArgumentRemainder"};var XPathPathExpr={label:"PathExpr"};var XPathUnionExpr={label:"UnionExpr"};var XPathFilterExpr={label:"FilterExpr"};var XPathDigits={label:"Digits"};var xpathNonTerminals=[XPathLocationPath,XPathRelativeLocationPath,XPathAbsoluteLocationPath,XPathStep,XPathNodeTest,XPathPredicate,XPathLiteral,XPathExpr,XPathPrimaryExpr,XPathVariableReference,XPathNumber,XPathFunctionCall,XPathArgumentRemainder,XPathPathExpr,XPathUnionExpr,XPathFilterExpr,XPathDigits];var Q_01={label:"?"};var Q_MM={label:"*"};var Q_1M={label:"+"};var ASSOC_LEFT=true;var xpathGrammarRules=[[XPathLocationPath,[XPathRelativeLocationPath],18,passExpr],[XPathLocationPath,[XPathAbsoluteLocationPath],18,passExpr],[XPathAbsoluteLocationPath,[TOK_SLASH,XPathRelativeLocationPath],18,makeLocationExpr1],[XPathAbsoluteLocationPath,[TOK_DSLASH,XPathRelativeLocationPath],18,makeLocationExpr2],[XPathAbsoluteLocationPath,[TOK_SLASH],0,makeLocationExpr3],[XPathAbsoluteLocationPath,[TOK_DSLASH],0,makeLocationExpr4],[XPathRelativeLocationPath,[XPathStep],31,makeLocationExpr5],[XPathRelativeLocationPath,[XPathRelativeLocationPath,TOK_SLASH,XPathStep],31,makeLocationExpr6],[XPathRelativeLocationPath,[XPathRelativeLocationPath,TOK_DSLASH,XPathStep],31,makeLocationExpr7],[XPathStep,[TOK_DOT],33,makeStepExpr1],[XPathStep,[TOK_DDOT],33,makeStepExpr2],[XPathStep,[TOK_AXISNAME,TOK_AXIS,XPathNodeTest],33,makeStepExpr3],[XPathStep,[TOK_AT,XPathNodeTest],33,makeStepExpr4],[XPathStep,[XPathNodeTest],33,makeStepExpr5],[XPathStep,[XPathStep,XPathPredicate],33,makeStepExpr6],[XPathNodeTest,[TOK_ASTERISK],33,makeNodeTestExpr1],[XPathNodeTest,[TOK_NCNAME,TOK_COLON,TOK_ASTERISK],33,makeNodeTestExpr2],[XPathNodeTest,[TOK_QNAME],33,makeNodeTestExpr3],[XPathNodeTest,[TOK_NODEO,TOK_PARENC],33,makeNodeTestExpr4],[XPathNodeTest,[TOK_NODEO,XPathLiteral,TOK_PARENC],33,makeNodeTestExpr5],[XPathPredicate,[TOK_BRACKO,XPathExpr,TOK_BRACKC],33,makePredicateExpr],[XPathPrimaryExpr,[XPathVariableReference],33,passExpr],[XPathPrimaryExpr,[TOK_PARENO,XPathExpr,TOK_PARENC],33,makePrimaryExpr],[XPathPrimaryExpr,[XPathLiteral],30,passExpr],[XPathPrimaryExpr,[XPathNumber],30,passExpr],[XPathPrimaryExpr,[XPathFunctionCall],30,passExpr],[XPathFunctionCall,[TOK_QNAME,TOK_PARENO,TOK_PARENC],-1,makeFunctionCallExpr1],[XPathFunctionCall,[TOK_QNAME,TOK_PARENO,XPathExpr,XPathArgumentRemainder,Q_MM,TOK_PARENC],-1,makeFunctionCallExpr2],[XPathArgumentRemainder,[TOK_COMMA,XPathExpr],-1,makeArgumentExpr],[XPathUnionExpr,[XPathPathExpr],20,passExpr],[XPathUnionExpr,[XPathUnionExpr,TOK_PIPE,XPathPathExpr],20,makeUnionExpr],[XPathPathExpr,[XPathLocationPath],20,passExpr],[XPathPathExpr,[XPathFilterExpr],19,passExpr],[XPathPathExpr,[XPathFilterExpr,TOK_SLASH,XPathRelativeLocationPath],20,makePathExpr1],[XPathPathExpr,[XPathFilterExpr,TOK_DSLASH,XPathRelativeLocationPath],20,makePathExpr2],[XPathFilterExpr,[XPathPrimaryExpr,XPathPredicate,Q_MM],20,makeFilterExpr],[XPathExpr,[XPathPrimaryExpr],16,passExpr],[XPathExpr,[XPathUnionExpr],16,passExpr],[XPathExpr,[TOK_MINUS,XPathExpr],-1,makeUnaryMinusExpr],[XPathExpr,[XPathExpr,TOK_OR,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_AND,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_EQ,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_NEQ,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_LT,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_LE,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_GT,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_GE,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_PLUS,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathExpr,[XPathExpr,TOK_MINUS,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathExpr,[XPathExpr,TOK_ASTERISK,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathExpr,[XPathExpr,TOK_DIV,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathExpr,[XPathExpr,TOK_MOD,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathLiteral,[TOK_LITERALQ],-1,makeLiteralExpr],[XPathLiteral,[TOK_LITERALQQ],-1,makeLiteralExpr],[XPathNumber,[TOK_NUMBER],-1,makeNumberExpr],[XPathVariableReference,[TOK_DOLLAR,TOK_QNAME],200,makeVariableReference]];var xpathRules=[];function xpathParseInit(){if(xpathRules.length){return}xpathGrammarRules.sort(function(a,b){var c=a[1].length;var d=b[1].length;if(c<d){return 1}else if(c>d){return-1}else{return 0}});var k=1;for(var i=0;i<xpathNonTerminals.length;++i){xpathNonTerminals[i].key=k++}for(i=0;i<xpathTokenRules.length;++i){xpathTokenRules[i].key=k++}xpathLog('XPath parse INIT: '+k+' rules');function push_(a,b,c){if(!a[b]){a[b]=[]}a[b].push(c)}for(i=0;i<xpathGrammarRules.length;++i){var e=xpathGrammarRules[i];var f=e[1];for(var j=f.length-1;j>=0;--j){if(f[j]==Q_1M){push_(xpathRules,f[j-1].key,e);break}else if(f[j]==Q_MM||f[j]==Q_01){push_(xpathRules,f[j-1].key,e);--j}else{push_(xpathRules,f[j].key,e);break}}}xpathLog('XPath parse INIT: '+xpathRules.length+' rule bins');var g=0;mapExec(xpathRules,function(i){if(i){g+=i.length}});xpathLog('XPath parse INIT: '+(g/xpathRules.length)+' average bin size')}function xpathCollectDescendants(a,b){for(var n=b.firstChild;n;n=n.nextSibling){a.push(n);arguments.callee(a,n)}}function xpathCollectDescendantsReverse(a,b){for(var n=b.lastChild;n;n=n.previousSibling){a.push(n);arguments.callee(a,n)}}function xpathDomEval(a,b){var c=xpathParse(a);var d=c.evaluate(new ExprContext(b));return d}function xpathSort(a,b){if(b.length==0){return}var c=[];for(var i=0;i<a.contextSize();++i){var d=a.nodelist[i];var e={node:d,key:[]};var f=a.clone(d,0,[d]);for(var j=0;j<b.length;++j){var s=b[j];var g=s.expr.evaluate(f);var h;if(s.type=='text'){h=g.stringValue()}else if(s.type=='number'){h=g.numberValue()}e.key.push({value:h,order:s.order})}e.key.push({value:i,order:'ascending'});c.push(e)}c.sort(xpathSortByKey);var k=[];for(var i=0;i<c.length;++i){k.push(c[i].node)}a.nodelist=k;a.setNode(0)}function xpathSortByKey(a,b){for(var i=0;i<a.key.length;++i){var o=a.key[i].order=='descending'?-1:1;if(a.key[i].value>b.key[i].value){return+1*o}else if(a.key[i].value<b.key[i].value){return-1*o}}return 0}function xpathEval(a,b){var c=xpathParse(a);var d=c.evaluate(b);return d}